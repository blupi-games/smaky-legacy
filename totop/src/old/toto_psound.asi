	.SBTTL	TOTO_PSOUND.ASI;--------\\; SNDPLAY >;========/; Fait entendre un son (SMAKY-300).; in	D4.W	numro du son (0..n);		  0..3: rang dans le fichier;		 4..15: numro du fichier; out	D7.W	erreur; mod	D7.WSNDPLAY:	PUSHM.L	D3,D4,D6,A3,A4	COMP.B	(A6)+OMACHINE,#SMAKY300	JUMP,NE ERROR$	CALL	SNDCACHE	; A4 <-- ^son	JUMP,NE EXIT$	LOAD.W	D3,D4	AND.W	D3,#H'000FSRC$:	DEC.W	D3	JUMP',NS FOUND$	LOAD.L	D4,(A4)+OADHLG	; D4 <-- lg	LOAD.L	A4,#(A4)+(D4.L)+LADH ; A4 <-- ^suivant	JUMP	SRC$FOUND$:	LOAD.L	A3,#R16"NMAUDIO	LOAD.W	D3,#2^BOPWR	FOS	?OPEN		; ouvre #AUDIO:	JUMP',NE EXIT$	LOAD.L	D4,(A4)+OADHLG	; D4 <-- lg	ADD.L	D4,#LADH	FOS	?WRBYTE		; joue l'chantillon	FOS	?CLOSE		; ferme #AUDIO:	CLR.W	D7		; D7 <-- ok	JUMP'	EXIT$ERROR$:	LOAD.W	D7,#1EXIT$:	POPM.L	D3,D4,D6,A3,A4	TEST.W	D7		; retour EQ/NE	RET;---------\\; SNDCACHE >;=========/; Cache un son, si ncessaire.; in	D4.W	numro du son (0..n); out	A4.L	^son;	D7.W	erreur; mod	D7.W, A4.LSNDCACHE:	PUSHM.L	D4,A2,A3	CALL	SNDGETD		; A2 <-- ^ODS*	TEST.L	(A2)+ODSPT	; son dj charg ?	JUMP',NE OK$		; oui => OK$	CALL	SNDNAME		; A3 <-- ^nom	CALL	SNDREAD		; lit un son	JUMP',NE EXIT$	LOAD.L	(A2)+ODSPT,A4	LOAD.L	(A2)+ODSLG,D4OK$:	LOAD.L	A4,(A2)+ODSPT	; A4 <-- ^son	CLR.W	D7		; D7 <-- okEXIT$:	POPM.L	D4,A2,A3	TEST.W	D7		; retour EQ/NE	RET;-----------\\; SNDUNCACHE >;===========/; Dcache un son, si ncessaire.; in	D4.W	numro du son (0..n); out	-; mod	D7.WSNDUNCACHE:	PUSHM.L	D1,A2,A4	CALL	SNDGETD		; A2 <-- ^ODS*	TEST.L	(A2)+ODSPT	; son dj libr ?	JUMP',EQ EXIT$		; oui => EXIT$	LOAD.L	A4,(A2)+ODSPT	LOAD.W	D1,#MTYPCP	GESMEM	?GIVMEM		; libre le son	CLR.L	(A2)+ODSPTEXIT$:	POPM.L	D1,A2,A4	RET;--------\\; SDNGETD >;--------/; Cherche le descripteur d'un son.; in	D4.W	numro du son (0..n); out	A2.L	^ODS*; mod	D7.W, A2.LSNDGETD:	PUSH.L	D4	LOAD.L	A2,#(A6)+ODS	SR.W	D4,#4	MUL.WU	D4,#LDS	ADD.L	A2,D4		; A2 <-- ^ODS*	POP.L	D4	RET;--------\\; SNDNAME >;--------/; Gnre le nom d'un son.; in	D4.W	numro du son (0..999); out	A3.L	^nom; mod	D7.W, A3.LSNDNAME:	PUSHM.L	D2..D4,A4	LOAD.L	A4,#(A6)+OBUDIS	LOAD.L	A3,#R16"PREF$XFER1$:	LOAD.B	(A4+),(A3+)	; OBUDIS <-- prfixe	JUMP,NE XFER1$	DEC.L	A4	LOAD.W	D2,#2^BAFDALL	LOAD.W	D3,#3	SR.W	D4,#4	AND.L	D4,#H'FFFF	LIB	?PUTDEC		; OBUDIS <-- numro	LOAD.L	A3,#R16"POST$XFER2$:	LOAD.B	(A4+),(A3+)	; OBUDIS <-- extension	JUMP,NE XFER2$;	DEC.L	A4	LOAD.L	A3,#(A6)+OBUDIS	; A3 <-- ^nom	POPM.L	D2..D4,A4	RETPREF$:	.ASCIZ	"(:,#:)TOTO_P"POST$:	.ASCIZ	".AUDIO"	.EVEN;--------\\; SNDREAD >;========/; Lit un fichier TOTO_Pnnn.AUDIO; in	A3.L	^nom; out	A4.L	^data;	D4.L	lg data;	D7.W	erreur; mod	D4.L, D7.W, A4.LSNDREAD:	PUSHM.L	D1,D3,D6	LOAD.W	D3,#2^BOPRD	FOS	?OPEN	JUMP',NE EXIT$	LOAD.L	D3,#-1	LOAD.L	D4,D3	FOS	?SPOS		; D4 <-- longueur	PUSH.L	D4	CLR.L	D3	CLR.L	D4	FOS	?SPOS	POP.L	D4	LOAD.W	D1,#MTYPCP	CALL	GETMEM	JUMP',NE CLOSE$	FOS	?RDBYTECLOSE$:	PUSH.W	D7	FOS	?CLOSE	POP.W	D7EXIT$:	POPM.L	D1,D3,D6	TEST.W	D7		; retour EQ/NE	RET;-----------\\; SNDMUSIQUE >;===========/; Joue une musique.; in	A4.L	^table; out	-; mod	D7.WSNDMUSIQUE:	PUSHM.L	D0..D4,D6,A2..A4	LOAD.L	A3,#R16"NMAUDIO	LOAD.W	D3,#2^BOPWR	FOS	?OPEN		; ouvre #AUDIO:	JUMP,NE QUIT$	LOAD.L	A3,A4	LOAD.L	A2,#R16"TABLE$LOOP$:	TEST.W	(A3)	JUMP,EQ EXIT$	CLR.L	D0	LOAD.W	D0,(A3+)	JUMP',EQ NOTE0$	SL.W	D0,#1	LOAD.W	D0,(A2)+(D0.W)	DIV.WU	D0,#3NOTE0$:	CLR.L	D1	LOAD.W	D1,(A3+)	JUMP',EQ NOTE1$	SL.W	D1,#1	LOAD.W	D1,(A2)+(D1.W)	DIV.WU	D1,#3NOTE1$:	CLR.L	D2	LOAD.W	D2,(A3+)	JUMP',EQ NOTE2$	SL.W	D2,#1	LOAD.W	D2,(A2)+(D2.W)	DIV.WU	D2,#3NOTE2$:;;?CLR.L D1	; <<<<<<< PARCE QUE LES ACCORDS SONNENT FAUX !!!!!CLR.L D2;;?	CLR.W	D4	LOAD.B	D4,(A3+)	; D4 <-- enveloppe	CLR.W	D3	LOAD.B	D3,(A3+)	; D3 <-- dure	JUMP',NE PLAY$	LOAD.W	D3,D4PLAY$:	SWAP.W	D4	LOAD.W	D4,D3	LOAD.L	A4,#(A6)+OBUSND	LOAD.W	D3,#(LADH/2)-1ZERO$:	CLR.W	(A4+)		; rempli l'en-tte de zro	DECJ.W,NMO D3,ZERO$	CALL	SNDACCORD	; calcule un accord	LOAD.L	A4,#(A4)-LADH	; A4 <-- ^en-tte	LOAD.B	(A4)+OADHTYP,#ADHTYPE	LOAD.L	(A4)+OADHLG,D4	LOAD.W	(A4)+OADHFREQ,#ADFREQ	ADD.L	D4,#LADH	FOS	?WRBYTE		; joue l'chantillon	JUMP	LOOP$EXIT$:	FOS	?CLOSE		; ferme #AUDIO:QUIT$:	POPM.L	D0..D4,D6,A2..A4	RET; Table des priodes pour les notes de la gamme tempre :TABLE$:	.W	3822.	3608.	3405.	3214.	3034.	2864.	.W	2703.	2551.	2408.	2273.	2145.	2025.	.W	1911.	1804.	1703.	1607.	1517.	1432.	.W	1351.	1276.	1204.	1136.	1073.	1012.	.W	956.	902.	851.	804.	758.	716.	.W	676.	638.	602.	568.	536.	506.	.W	478.	451.	426.	402.	379.	358.	.W	338.	319.	301.	284.	268.	253.	.W	239.	225.	213.	201.	190.	179.	.W	169.	159.	150.	142.	134.	127.	.W	119.	113.	106.	100.	95.	89.	.W	84.	80.	75.	71.	67.	63.	.W	60.	56.	53.	50.	47.	45.	.W	42.	40.	38.	36.	34.	32.	.W	30.	28.	27.	25.	24.	22.	.W	21.	20.	19.	18.	17.	16.	.W	15.	14.	13.	13.	12.	11.	.W	11.	10.	9.	9.	8.	8.	.W	7.	7.	7.	6.	6.	6.	.W	5.	5.	5.	4.	4.	4.	.W	4.	4.	3.	3.	3.	3.	.W	3.	2.	2.	2.	2.	2.	.W	2.	2.	2.	2.	1.	1.	.W	1.	1.	1.	1.	1.	1.	.W	1.	1.	1.	1.	1.	1.	.W	1.	1.	1.	1.	1.	1.;----------\\; SNDACCORD >;==========/; Joue un accord, compatible avec l'appel LIB ?ACCORD; in	D0.W	premire note;	D1.W	seconde note;	D2.W	troisme note;	D4.W	dure en [20ms];	D4.LH	enveloppe en [20ms];	A4.L	^destination; out	D4.L	longueur utilise; mod	D4.L, D7.WSNDACCORD:	PUSHM.L	D0..D3,D5,D6,A4	LOAD.L	D7,D4	SWAP.W	D7		; D7 <-- enveloppe	MUL.WU	D7,#ADFREQ/50	DIV.WU	D7,#ADNIVMAX/6	LOAD.W	D6,D7	SWAP.W	D7	LOAD.W	D7,D6		; D7 <-- copie dans high word	MUL.WU	D4,#ADFREQ/50	; D4 <-- longueur	PUSH.L	D4	LOAD.W	D5,#ADNIVMAX/6	; D5 <-- coefficient	CLR.L	D6		; D6 <-- clear flags	TEST.W	D0	JUMP',NE S1$	TSET.L	D6:#19		; D6 <-- la note 0 est un silenceS1$:	SWAP.W	D0		; D0 <-- mmorise dans le high word	LOAD.W	D0,#1		; D0 <-- rechargement au coup suivant	TEST.W	D1	JUMP',NE S2$	TSET.L	D6:#20		; D6 <-- la note 1 est un silenceS2$:	SWAP.W	D1		; D1 <-- mmorise dans le high word	LOAD.W	D1,#1		; D1 <-- rechargement au coup suivant	TEST.W	D2	JUMP',NE S3$	TSET.L	D6:#21		; D6 <-- la note 2 est un silenceS3$:	SWAP.W	D2		; D2 <-- mmorise dans le high word	LOAD.W	D2,#1		; D2 <-- rechargement au coup suivantLOOP$:	DEC.W	D0	JUMP',NE E1$	TNOT.L	D6:#16	SWAP.W	D0	LOAD.W	D6,D0	SWAP.W	D0	LOAD.W	D0,D6		; D0 <-- recharge le low wordE1$:	DEC.W	D1	JUMP',NE E2$	TNOT.L	D6:#17	SWAP.W	D1	LOAD.W	D6,D1	SWAP.W	D1	LOAD.W	D1,D6		; D1 <-- recharge le low wordE2$:	DEC.W	D2	JUMP',NE E3$	TNOT.L	D6:#18	SWAP.W	D2	LOAD.W	D6,D2	SWAP.W	D2	LOAD.W	D2,D6		; D2 <-- recharge le low wordE3$:	DEC.W	D7	JUMP',NE VAL$	TEST.W	D5	JUMP',EQ VAL$	DEC.W	D5		; D5 <-- coefficient diminue	SWAP.W	D7	LOAD.W	D6,D7	SWAP.W	D7	LOAD.W	D7,D6		; D7 <-- recharge le low wordVAL$:	LOAD.W	D3,#ADNIVMAX/2	; D3 <-- niveau "zro"	TEST.L	D6:#19		; note 0 = silence ?	JUMP',BS B1$	SUB.W	D3,D5	TEST.L	D6:#16	JUMP',BC B1$	ADD.W	D3,D5	ADD.W	D3,D5B1$:	TEST.L	D6:#20		; note 1 = silence ?	JUMP',BS B2$	SUB.W	D3,D5	TEST.L	D6:#17	JUMP',BC B2$	ADD.W	D3,D5	ADD.W	D3,D5B2$:	TEST.L	D6:#21		; note 2 = silence ?	JUMP',BS B3$	SUB.W	D3,D5	TEST.L	D6:#18	JUMP',BC B3$	ADD.W	D3,D5	ADD.W	D3,D5B3$:	LOAD.B	(A4+),D3	; buffer <-- crit l'chantillon	DEC.L	D4		; D4 <-- compteur de dure	JUMP,NE	LOOP$	POP.L	D4	POPM.L	D0..D3,D5,D6,A4	RETNMAUDIO:.ASCIZ	"#AUDIO:"	.EVEN	.END