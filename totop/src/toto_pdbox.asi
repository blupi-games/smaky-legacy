	.SBTTL	TOTO PDBOX.ASI;-----------\\; DBOXQUITTE >;===========/; Quitte TOTO ?; in	-; out	D3.W	F1/F4; mod	D7.WDBOXQUITTE:	PUSHM.L	D0..D2,D4..D6,A3..A5	CALL	SCMO		; visible	LOAD.W	D1,#DBOX_QUITTE	LOAD.L	D2,#2^BDBSAV!2^BDBEXTEND	CLR.L	D3	CLR.L	D4		; D4 <-- fanions	LOAD.L	A3,#R16"TDBOX_IO	DBOX_	EXTEND		; demande s'il faut quitter ...	CALL	AFMENU		; refait les soft-keys	POPM.L	D0..D2,D4..D6,A3..A5	RET;----------\\; DBOXPREND >;==========/; Lit une partie .TOTOP; in	A4.L	^dans TABLE; out	A4.L	^dans TABLE; mod	D7.W, A4.LDBOXPREND:	PUSHM.L	D0..D6,A2,A3,A5	LOAD.L	A2,A4		; A2 <-- ^absolu dans TABLE	CALL	SCMO		; visibleLOOP$:	CALL	NORMMOUSE	; souris: enlve le sablier	LOAD.W	D1,#DBOX_PREND	LOAD.L	D2,#2^BDBSAV!2^BDBEXTEND	LOAD.L	D3,#LBUFILE!2^BDBIOEXT1	CLR.L	D4		; D4 <-- fanions	LOAD.L	A3,#R16"TDBOX_IO	LOAD.L	A4,#R16"TEXT_IO	LOAD.L	A5,#(A6)+OBUFILE ; A5 <-- ^nom  diter	DBOX_	EXTEND		; demande le nom ...	JUMP,NE END$	LOAD.W	D7,#ERKSTO	COMP.W	D3,#F1	JUMP,NE END$	CALL	WAITMOUSE	; souris: met le sablier	LOAD.L	A3,#(A6)+OBUFILE ; A3 <-- ^nom	LOAD.W	D3,#2^BOPRD	LOAD.L	D0,#FOS?OPEN	CALL	ERCALL		; ouvre le fichier .TOTO	JUMP',EQ READ$	COMP.W	D7,#ERKSTO	; annule ?	JUMP,EQ END$		; oui => END$ERROR$:	PUSH.W	D7	CALL	NORMMOUSE	; souris: enlve le sablier	LOAD.W	D3,#BIPERR	LIB	?BEEP	POP.W	D7	LOAD.W	D2,#2^BDBSAV	DBOX_	MERROR		; affiche l'erreur ...	JUMP	LOOP$READ$:	LOAD.L	A4,#(A6)+OBUHEAD	LOAD.L	D4,#LHEAD	FOS	?RDBYTE		; lit l'en-tte	JUMP',NE CLOSE$	LOAD.W	D7,#ERFOS	COMP.L	(A4)+OHDID,#HDID	JUMP',NE CLOSE$	COMP.B	(A4)+OHDREV,#TOTOREV	JUMP',NE CLOSE$	COMP.B	(A4)+OHDVERS,#TOTOVERS	JUMP',NE CLOSE$	COMP.W	(A4)+OHDNBO,#NBSEARCH	JUMP',NE CLOSE$	COMP.W	(A4)+OHDLGO,#LDO	JUMP',NE CLOSE$	LOAD.L	A4,#(A6)+ODO	LOAD.L	D4,#LDO*NBSEARCH	FOS	?RDBYTE		; lit les objets	JUMP',NE CLOSE$	LOAD.L	(A6)+OFAN,(A6)+OBUHEAD+OHDFAN	LOAD.W	(A6)+OREST,(A6)+OBUHEAD+OHDREST	LOAD.W	(A6)+OIMA,(A6)+OBUHEAD+OHDIMA	LOAD.L	A2,#R16"TABLE	ADD.L	A2,(A6)+OBUHEAD+OHDPTRCLOSE$:	PUSH.W	D7	FOS	?CLOSE		; ferme le fichier .TOTO	POP.W	D7	JUMP,NE ERROR$END$:	PUSH.W	D7	CALL	NORMMOUSE	; souris: enlve le sablier	CALL	CCMO		; invisible	CALL	AFMENU		; refait les soft-keys	POP.W	D7	LOAD.L	A4,A2		; A4 <-- ^dans TABLE	POPM.L	D0..D6,A2,A3,A5	TEST.W	D7		; retour EQ/NE	RET;----------\\; DBOXSAUVE >;==========/; Sauve la partie .TOTOP; in	A4.L	^dans TABLE; out	-; mod	D7.WDBOXSAUVE:	PUSHM.L	D0..D6,A2..A5	LOAD.L	A2,#R16"TABLE	SUB.L	A4,A2	LOAD.L	A2,A4		; A2 <-- ^relatif dans TABLE	CALL	SCMO		; visibleLOOP$:	CALL	NORMMOUSE	; souris: enlve le sablier	LOAD.W	D1,#DBOX_SAUVE	LOAD.L	D2,#2^BDBSAV!2^BDBEXTEND	LOAD.L	D3,#LBUFILE!2^BDBIOEXT1	CLR.L	D4		; D4 <-- fanions	LOAD.L	A3,#R16"TDBOX_IO	LOAD.L	A4,#R16"TEXT_IO	LOAD.L	A5,#(A6)+OBUFILE ; A5 <-- ^nom  diter	DBOX_	EXTEND		; demande le nom ...	JUMP,NE END$	COMP.W	D3,#F1	JUMP',EQ GO$	COMP.W	D3,#F4	JUMP,NE END$GO$:	LOAD.W	D1,D3		; D1 <-- F1/F4	CALL	WAITMOUSE	; souris: met le sablierCREATE$:	LOAD.L	A3,#(A6)+OBUFILE ; A3 <-- ^nom	LOAD.L	D3,#DEFATT	; D3 <-- attributs par dfaut	LOAD.W	D4,#TYPRAND	; D4 <-- type "random"	LOAD.L	D0,#FOS?CREATE	CALL	ERCALL		; cre le fichier .TOTO	JUMP,EQ OPEN$		; ok => OPEN$	COMP.W	D7,#ERKSTO	; annule ?	JUMP,EQ END$		; oui => END$	COMP.W	D7,#ERFAEX	; fichier existe dj ?	JUMP,NE	ERROR$		; non => ERROR$				; oui =>	COMP.W	D1,#F4		; touche (MET A JOUR) ?	JUMP',EQ DELETE$	; oui => DELETE$	CALL	NORMMOUSE	; souris: enlve le sablier	PUSH.L	D2	LOAD.W	D2,#2^BDBSAV	; D2 <-- mode	LIST_	DELETE		; dtruit le fichier ?	POP.L	D2	TEST.W	D7	JUMP',NE ERROR$	COMP.W	D3,#'O	JUMP,NE LOOP$DELETE$:	LOAD.L	D0,#FOS?DELETE	CALL	ERCALL		; dtruit le fichier	JUMP,NE END$	JUMP	CREATE$OPEN$:	CALL	WAITMOUSE	; souris: met le sablier	LOAD.L	A3,#(A6)+OBUFILE ; A3 <-- ^nom	LOAD.W	D3,#2^BOPWR!2^BOPEXCL	LOAD.L	D0,#FOS?OPEN	CALL	ERCALL		; ouvre le fichier .TOTO	JUMP',EQ WRITE$	COMP.W	D7,#ERKSTO	; annule ?	JUMP,EQ END$		; oui => END$ERROR$:	PUSH.W	D7	CALL	NORMMOUSE	; souris: enlve le sablier	LOAD.W	D3,#BIPERR	LIB	?BEEP	POP.W	D7	LOAD.W	D2,#2^BDBSAV	DBOX_	MERROR		; affiche l'erreur ...	JUMP	LOOP$WRITE$:	LOAD.L	A4,#(A6)+OBUHEAD	LOAD.L	D4,#LHEAD	GESMEM	?CLEARMEM	LOAD.L	(A4)+OHDID,#HDID	LOAD.B	(A4)+OHDREV,#TOTOREV	LOAD.B	(A4)+OHDVERS,#TOTOVERS	LOAD.W	(A4)+OHDNBO,#NBSEARCH	LOAD.W	(A4)+OHDLGO,#LDO	LOAD.L	(A4)+OHDFAN,(A6)+OFAN	LOAD.W	(A4)+OHDREST,(A6)+OREST	LOAD.W	(A4)+OHDIMA,(A6)+OIMA	LOAD.L	(A4)+OHDPTR,A2	FOS	?WRBYTE		; crit l'en-tte	JUMP',NE CLOSE$	LOAD.L	A4,#(A6)+ODO	LOAD.L	D4,#LDO*NBSEARCH	FOS	?WRBYTE		; crit les objets	JUMP',EQ CLOSE$WRERR$:	PUSH.W	D7	FOS	?CLOSE		; ferme le fichier .TOTO	POP.W	D7	JUMP	ERROR$CLOSE$:	FOS	?CLOSE		; ferme le fichier .TOTO	JUMP,NE ERROR$END$:	CALL	NORMMOUSE	; souris: enlve le sablier	CALL	CCMO		; invisible	CALL	AFMENU		; refait les soft-keys	POPM.L	D0..D6,A2..A5	RET;--------\\; DBOXDEF >;========/; Dbox pour choisir le mode.; in	-; out	D3.W	dernire touche (CR/END);	D7.W	erreur; mod	D3.L, D7.WDBOXDEF:	PUSHM.L	D0..D2,D4,D5,A1..A4	CALL	SCMO		; visible	LOAD.L	D4,(A6)+OFAN	LOAD.L	A2,#R16"TDBOX_DEF	LOAD.W	D2,#2^BDBSAV	; D2 <-- mode	DBOX_	OPEN		; ouvre la DBOX	JUMP,NE	END$LOOP$:	DBOX_	EDIT		; attend une action ...	LOAD.L	A1,#R16"TKEY_DEF	LOAD.W	D1,#2^BDBCCMM!2^BDBCCFF	DBOX_	CALLC	COMP.W	D3,#KEYMGR	; bouton souris relach ?	JUMP,EQ	LOOP$		; oui => LOOP$	COMP.W	D3,#CR		; D'ACCORD ?	JUMP',EQ OK$	COMP.W	D3,#END		; ANNULE ?	JUMP',EQ CLOSE$BIP$:	LOAD.B	D3,#BIPLIT	LIB	?BEEP		; p'tit bruit	JUMP	LOOP$OK$:	LOAD.L	(A6)+OFAN,D4CLOSE$:	DBOX_	CLOSE		; ferme la DBOXEND$:	CALL	CCMO		; invisible	CALL	AFMENU		; refait les soft-keys	POPM.L	D0..D2,D4,D5,A1..A4	TEST.W	D7		; retour EQ/NE	RETTDBOX_DEF:	.W	10$-TDBOX_DEF	.W	20$-TDBOX_DEF	.W	0,010$:	.B	ODBSQUARE,BFSON	.ASCIZ	" musiques et bruitages"	.B	ODBCR	.B	ODBSQUARE,BFQUICK	.ASCIZ	" affichage rapide (sans transition)"	.B	ODBCR	.B	ODBSQUARE,BFHELP	.ASCIZ	" aide pour les pices oublies"	.B	ODBCR	.B	ODBCR,ODBCR	.B	ODBBOX,0,CR,TDBMEV	.ASCIZ	" D'ACCORD "	.B	ODBTEXT	.ASCIZ	"    "	.B	ODBBOX,0,END,TDBNORM	.ASCIZ	"  ANNULE  "	.B	020$:	.ASCIZ	""	.ASCIZ	""		;     ;     ;     ;	.ASCIZ	""	.ASCIZ	"D'accord"		;     ;     ;     ;	.ASCIZ	""	.ASCIZ	""		;     ;     ;     ;	.ASCIZ	""	.ASCIZ	""		;     ;     ;     ;	.ASCIZ	""	.ASCIZ	""		;     ;     ;     ;	.ASCIZ	""	.ASCIZ	"Annule"	.EVENTKEY_DEF:	.W	F1,F2,F3,CR,0		DOKCR-TKEY_DEF	.W	F0,F13,F14,F15,END,0	DOKEND-TKEY_DEF	.W	KEYMGR,KEYMMR,KEYMDR,0	DOKMGR-TKEY_DEF	.W	0;--------\\; DBOXNEW >;========/; Dbox pour choisir le mode.; in	-; out	D3.W	dernire touche (CR/END);	D7.W	erreur; mod	D3.L, D7.WDBOXNEW:	PUSHM.L	D0..D2,D4,D5,A1..A4	CALL	SCMO		; visible	CLR.L	D4	LOAD.L	A2,#R16"TDBOX_NEW	LOAD.W	D2,#2^BDBSAV	; D2 <-- mode	DBOX_	OPEN		; ouvre la DBOX	JUMP,NE	END$LOOP$:	DBOX_	EDIT		; attend une action ...	LOAD.L	A1,#R16"TKEY_NEW	LOAD.W	D1,#2^BDBCCMM!2^BDBCCFF	DBOX_	CALLC	COMP.W	D3,#KEYMGR	; bouton souris relach ?	JUMP,EQ	LOOP$		; oui => LOOP$	COMP.W	D3,#CR		; OUI ?	JUMP',EQ CLOSE$	COMP.W	D3,#END		; NON ?	JUMP',EQ CLOSE$BIP$:	LOAD.B	D3,#BIPLIT	LIB	?BEEP		; p'tit bruit	JUMP	LOOP$CLOSE$:	DBOX_	CLOSE		; ferme la DBOXEND$:	CALL	CCMO		; invisible	CALL	AFMENU		; refait les soft-keys	POPM.L	D0..D2,D4,D5,A1..A4	TEST.W	D7		; retour EQ/NE	RETTDBOX_NEW:	.W	10$-TDBOX_NEW	.W	20$-TDBOX_NEW	.W	0,010$:	.B	ODBTEXT	.ASCIZ	"Voulez-vous recommencer"	.B	ODBCR	.B	ODBTEXT	.ASCIZ	"une nouvelle partie ?"	.B	ODBCR	.B	ODBCR,ODBCR	.B	ODBBOX,0,CR,TDBNORM	.ASCIZ	"  OUI  "	.B	ODBTEXT	.ASCIZ	"    "	.B	ODBBOX,0,END,TDBMEV	.ASCIZ	"  NON  "	.B	020$:	.ASCIZ	""	.ASCIZ	""		;     ;     ;     ;	.ASCIZ	""	.ASCIZ	"Oui"		;     ;     ;     ;	.ASCIZ	""	.ASCIZ	""		;     ;     ;     ;	.ASCIZ	""	.ASCIZ	""		;     ;     ;     ;	.ASCIZ	""	.ASCIZ	""		;     ;     ;     ;	.ASCIZ	""	.ASCIZ	"Non"	.EVENTKEY_NEW:	.W	F1,F2,F3,CR,0		DOKCR-TKEY_NEW	.W	F0,F13,F14,F15,END,0	DOKEND-TKEY_NEW	.W	KEYMGR,KEYMMR,KEYMDR,0	DOKMGR-TKEY_NEW	.W	0;----------\\; DBOXWDEMO >;==========/; Dbox pour choisir le mode.; in	-; out	D3.W	dernire touche (CR/END);	D7.W	erreur; mod	D3.L, D7.WDBOXWDEMO:	PUSHM.L	D0..D2,D4,D5,A1..A4	CALL	SCMO		; visible	CLR.L	D4	LOAD.L	A2,#R16"TDBOX_WDEMO	LOAD.W	D2,#2^BDBSAV	; D2 <-- mode	DBOX_	OPEN		; ouvre la DBOX	JUMP,NE	END$LOOP$:	DBOX_	EDIT		; attend une action ...	LOAD.L	A1,#R16"TKEY_WDEMO	LOAD.W	D1,#2^BDBCCMM!2^BDBCCFF	DBOX_	CALLC	COMP.W	D3,#KEYMGR	; bouton souris relach ?	JUMP,EQ	LOOP$		; oui => LOOP$	COMP.W	D3,#CR		; OUI ?	JUMP',EQ CLOSE$	COMP.W	D3,#END		; NON ?	JUMP',EQ CLOSE$BIP$:	LOAD.B	D3,#BIPLIT	LIB	?BEEP		; p'tit bruit	JUMP	LOOP$CLOSE$:	DBOX_	CLOSE		; ferme la DBOXEND$:	CALL	CCMO		; invisible	CALL	AFMENU		; refait les soft-keys	POPM.L	D0..D2,D4,D5,A1..A4	TEST.W	D7		; retour EQ/NE	RETTDBOX_WDEMO:	.W	10$-TDBOX_WDEMO	.W	20$-TDBOX_WDEMO	.W	0,010$:	.B	ODBTEXT	.ASCIZ	"Voulez-vous sauver toutes les actions"	.B	ODBCR	.B	ODBTEXT	.ASCIZ	"dans le fichier TOTO_P.DEMO ?"	.B	ODBCR	.B	ODBCR,ODBCR	.B	ODBBOX,0,CR,TDBNORM	.ASCIZ	"  OUI  "	.B	ODBTEXT	.ASCIZ	"    "	.B	ODBBOX,0,END,TDBMEV	.ASCIZ	"  NON  "	.B	020$:	.ASCIZ	""	.ASCIZ	""		;     ;     ;     ;	.ASCIZ	""	.ASCIZ	"Oui"		;     ;     ;     ;	.ASCIZ	""	.ASCIZ	""		;     ;     ;     ;	.ASCIZ	""	.ASCIZ	""		;     ;     ;     ;	.ASCIZ	""	.ASCIZ	""		;     ;     ;     ;	.ASCIZ	""	.ASCIZ	"Non"	.EVENTKEY_WDEMO:	.W	F1,F2,F3,CR,0		DOKCR-TKEY_WDEMO	.W	F0,F13,F14,F15,END,0	DOKEND-TKEY_WDEMO	.W	KEYMGR,KEYMMR,KEYMDR,0	DOKMGR-TKEY_WDEMO	.W	0;----------\\; DBOXERROR >;==========/; Affiche une erreur.; in	D7.W	erreur; out	-; mod	D7.WDBOXERROR:	PUSHM.L	D2..D4	PUSH.W	D7	CALL	SCMO		; visible	CALL	NORMMOUSE	; souris: enlve le sablier	CALL	NORMMOUSE	; souris: enlve le sablier	LOAD.W	D3,#BIPERR	LIB	?BEEP	POP.W	D7	LOAD.W	D2,#2^BDBSAV	DBOX_	MERROR		; affiche l'erreur ...	CALL	AFMENU		; refait les soft-keysEXIT$:	POPM.L	D2..D4	TEST.W	D7		; retour EQ/NE	RET;--------\\; ERCALL  >;--------/; Excute un appel systme en essayant de rsoudre qq problmes.; in	D0.L	code de l'appel (par exemple #FOS?OPEN);	+ selon appel; out	+ selon appel;	D7.W	erreur (ERKSTO si annule); mod	D7.WERCALL:	PUSHM.L	D1,D2	LOAD.W	D1,#DBOX_ERCALL	; D1 <-- numro de l'appel	LOAD.W	D2,#2^BDBEXTEND	; D2 <-- mode "tendu"	DBOX_	EXTEND		; appel DBOX_ERCALL ...	POPM.L	D1,D2	TEST.W	D7		; retour EQ/NE	RETDOKCR:	LOAD.W	D3,#CR	RETDOKEND:	LOAD.W	D3,#END	RETDOKMGR:	LOAD.W	D3,#KEYMGR	RETTEXT_IO:	.ASCIZ	".TOTOP"	; extensionTDBOX_IO:	.ASCIZ	"TOTO"		; nom du logiciel	.ASCIZ	"Fpartie"	; [M,F] nom des lments manipuls	.ASCIZ	""		; [M,F] nom du contenant	.B	0	.EVEN	.END